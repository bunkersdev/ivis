<workflow-app name="wf_ivis_web_pln_upd" xmlns="uri:oozie:workflow:0.4">
    <global>
	    <job-xml>${hiveSite}</job-xml>
	    <job-xml>${hbasesite}</job-xml>
        <configuration>
            <property>
                <name>mapreduce.job.queuename</name>
                <value>${queueName}</value>
            </property>
        </configuration>
    </global>
    <credentials>
        <credential name='hcat_creds' type='hcat'>
            <property>
                <name>hcat.metastore.uri</name>
                <value>${metastore}</value>
            </property>
            <property>
                <name>hcat.metastore.principal</name>
                <value>${metastore_principal}</value>
            </property>
        </credential>
		
		<credential name='hbase' type='hbase'/>
    </credentials>   

    <start to="update_summary_inprocess_pln_upd"/>

 <!-- The Pig scripts does --> 
    <action name="update_summary_inprocess_pln_upd" cred="hcat_creds,hbase">
        <pig>
            <job-tracker>${jobTracker}</job-tracker>
            <name-node>${nameNode}</name-node>
            <script>${pigscriptsdirectory}/website/update_summary_status_inprocess.pig</script>
			<param>PHX_JAR_LOC=${phoenix_client_jar}</param>
			<param>TYPE=${PLAN_UPD}</param>
			<param>PHOENIX_SCHEMA_ENV=${phoenix_schema_env}</param>
			<param>PHOENIX_HBASE_CLUSTER=${phoenix_hbase_cluster}</param>
        </pig>
        <ok to="lnd_pln_upd_website"/>
		<error to="failureEmail"/>
    </action>	
		
	
 <!-- The Pig scripts does --> 
    <action name="lnd_pln_upd_website" cred="hcat_creds,hbase">
        <pig>
            <job-tracker>${jobTracker}</job-tracker>
            <name-node>${nameNode}</name-node>
            <script>${pigscriptsdirectory}/website/pln_upd/upload_pln_upd.pig</script>
			<param>PHX_JAR_LOC=${phoenix_client_jar}</param>
			<param>DATAFU_JAR_LOC=${datafu_jar}</param>
			<param>PLN_UPD_USR_VALIDATION_MACRO=${pln_upd_user_validation_macro}</param>
			<param>LOAD_FAILURE_MACRO=${load_failure_macro}</param>
			<param>PHOENIX_SCHEMA_ENV=${phoenix_schema_env}</param>
			<param>PHOENIX_HBASE_CLUSTER=${phoenix_hbase_cluster}</param>
			<param>IVIS_HIVE_DATABASE=${ivis_hive_database}</param>
        </pig>
        <ok to="send_email_failure_success"/>
		<error to="failureEmail"/>
    </action>
	
 <!-- The Pig scripts does --> 
    <action name="send_email_failure_success" cred="hcat_creds,hbase">
       <shell xmlns="uri:oozie:shell-action:0.1">
		 <job-tracker>${jobTracker}</job-tracker>
         <name-node>${nameNode}</name-node>
		 <exec>email.sh</exec>
		 <argument>${PLAN_UPD}</argument>
		 <argument>${UPLOAD_PLAN_UPD}</argument>
		 <argument>${phoenix_schema_env}</argument>
		 <argument>${phoenix_hbase_cluster}</argument>
		 <file>${shellscriptsdirectory}/website/email.sh#email.sh</file>
        </shell>
        <ok to="update_summary_processed_pln_upd"/>
        <error to="failureEmail"/>
    </action>

	
	  <!-- The Pig scripts does --> 
    <action name="update_summary_processed_pln_upd" cred="hcat_creds,hbase">
        <pig>
            <job-tracker>${jobTracker}</job-tracker>
            <name-node>${nameNode}</name-node>
            <script>${pigscriptsdirectory}/website/update_summary_status_processed.pig</script>
			<param>PHX_JAR_LOC=${phoenix_client_jar}</param>
			<param>TYPE=${PLAN_UPD}</param>
			<param>PHOENIX_SCHEMA_ENV=${phoenix_schema_env}</param>
			<param>PHOENIX_HBASE_CLUSTER=${phoenix_hbase_cluster}</param>
        </pig>
        <ok to="end"/>
		<error to="failureEmail"/>
    </action>	
	
	  <!-- In the event of failure, send an email to a larger group with some debugging info -->
    <action name="failureEmail">
        <email xmlns="uri:oozie:email-action:0.1">
            <to>${jobFailureEmails}</to>
            <subject> ${cluster_name} - JOB FAILURE ${wf:id()}</subject>
            <body>
                Error message is: [${wf:errorMessage(wf:lastErrorNode())}]

                Oozie job id: ${wf:id()}

                External Job Id is ${wf:actionExternalId(wf:lastErrorNode())}
		  
				Job log location is
				http://sn01.nonprod.scn:19888/jobhistory/job/${wf:actionExternalId(wf:lastErrorNode())}	
			
                This is an automatic e-mail generated by the job.
            </body>
        </email>
        <ok to="kill"/>
        <error to="kill"/>
    </action>

   
    <kill name="kill">
        <message>Action failed, error message[${wf:errorMessage(wf:lastErrorNode())}]</message>
    </kill>
	
    <end name="end"/>
</workflow-app>

	
